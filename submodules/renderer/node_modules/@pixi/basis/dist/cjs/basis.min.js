/*!
 * @pixi/basis - v6.5.10
 * Compiled Thu, 06 Jul 2023 15:25:11 UTC
 *
 * @pixi/basis is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,r,t,n,s=require("@pixi/core"),o=require("@pixi/constants"),a=require("@pixi/compressed-textures"),i=require("@pixi/loaders"),c=require("@pixi/settings");function u(e,r,t,n){return new(t||(t=Promise))((function(s,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function i(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var r;e.done?s(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,i)}c((n=n.apply(e,r||[])).next())}))}function l(e,r){var t,n,s,o,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(o){return function(i){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(s=a.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){a.label=o[1];break}if(6===o[0]&&a.label<s[1]){a.label=s[1],s=o;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(o);break}s[2]&&a.ops.pop(),a.trys.pop();continue}o=r.call(e,a)}catch(e){o=[6,e],n=0}finally{t=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}}exports.BASIS_FORMATS=void 0,(n=exports.BASIS_FORMATS||(exports.BASIS_FORMATS={}))[n.cTFETC1=0]="cTFETC1",n[n.cTFETC2=1]="cTFETC2",n[n.cTFBC1=2]="cTFBC1",n[n.cTFBC3=3]="cTFBC3",n[n.cTFBC4=4]="cTFBC4",n[n.cTFBC5=5]="cTFBC5",n[n.cTFBC7=6]="cTFBC7",n[n.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",n[n.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",n[n.cTFASTC_4x4=10]="cTFASTC_4x4",n[n.cTFATC_RGB=11]="cTFATC_RGB",n[n.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",n[n.cTFRGBA32=13]="cTFRGBA32",n[n.cTFRGB565=14]="cTFRGB565",n[n.cTFBGR565=15]="cTFBGR565",n[n.cTFRGBA4444=16]="cTFRGBA4444";var T=((e={})[exports.BASIS_FORMATS.cTFETC1]=a.INTERNAL_FORMATS.COMPRESSED_RGB_ETC1_WEBGL,e[exports.BASIS_FORMATS.cTFBC1]=a.INTERNAL_FORMATS.COMPRESSED_RGB_S3TC_DXT1_EXT,e[exports.BASIS_FORMATS.cTFBC3]=a.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT,e[exports.BASIS_FORMATS.cTFPVRTC1_4_RGB]=a.INTERNAL_FORMATS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,e[exports.BASIS_FORMATS.cTFPVRTC1_4_RGBA]=a.INTERNAL_FORMATS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,e[exports.BASIS_FORMATS.cTFATC_RGB]=a.INTERNAL_FORMATS.COMPRESSED_RGB_ATC_WEBGL,e[exports.BASIS_FORMATS.cTFASTC_4x4]=a.INTERNAL_FORMATS.COMPRESSED_RGBA_ASTC_4x4_KHR,e),d=((r={})[exports.BASIS_FORMATS.cTFRGBA32]=o.TYPES.UNSIGNED_BYTE,r[exports.BASIS_FORMATS.cTFRGB565]=o.TYPES.UNSIGNED_SHORT_5_6_5,r[exports.BASIS_FORMATS.cTFRGBA4444]=o.TYPES.UNSIGNED_SHORT_4_4_4_4,r),f=Object.keys(T).map((function(e){return Number(e)})).reduce((function(e,r){return e[T[r]]=r,e}),{}),_=((t={})[exports.BASIS_FORMATS.cTFBC3]=!0,t[exports.BASIS_FORMATS.cTFPVRTC1_4_RGBA]=!0,t[exports.BASIS_FORMATS.cTFASTC_4x4]=!0,t);function A(){var e,r={init:function(r){return self.BASIS?(self.BASIS({wasmBinary:r.wasmSource}).then((function(r){r.initializeBasis(),e=r,self.postMessage({type:"init",success:!0})})),null):(console.warn("jsSource was not prepended?"),{type:"init",success:!1})},transcode:function(r){var t=r.basisData,n=new e.BasisFile(t),s=n.getNumImages(),o=n.getHasAlpha()?r.rgbaFormat:r.rgbFormat,a=new Array(s),i=!1;if(!n.startTranscoding())return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!1,imageArray:null};for(var c=0;c<s;c++){for(var u=n.getNumLevels(c),l={imageID:c,levelArray:new Array,width:null,height:null},T=0;T<u;T++){var d=i?14:o,f=n.getImageWidth(c,T),_=n.getImageHeight(c,T),A=n.getImageTranscodedSizeInBytes(c,T,d),S=f+3&-4,R=_+3&-4;0===T&&(l.width=S,l.height=R);var B=new Uint8Array(A);if(!n.transcodeImage(B,c,T,d,!1,!1)){if(i)return console.error("Basis failed to transcode image "+c+", level "+T+"!"),{type:"transcode",requestID:r.requestID,success:!1};console.warn("Basis failed to transcode image "+c+", level "+T+"! Retrying to an uncompressed texture format!"),c=-1,i=!0;break}l.levelArray.push({levelID:T,levelWidth:f,levelHeight:_,levelBuffer:B})}a[c]=l}return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!0,basisFormat:i?14:o,imageArray:a}}};self.onmessage=function(e){var t=e.data,n=r[t.type](t);n&&self.postMessage(n)}}var S=function(){function e(){var r=this;this.requests={},this.onMessage=function(e){var t=e.data;if("init"===t.type){if(!t.success)throw new Error("BasisResource.TranscoderWorker failed to initialize.");r.isInit=!0,r.onInit()}else if("transcode"===t.type){--r.load;var n=t.requestID;t.success?r.requests[n].resolve(t):r.requests[n].reject(),delete r.requests[n]}},this.isInit=!1,this.load=0,this.initPromise=new Promise((function(e){r.onInit=e})),e.wasmSource||console.warn("PIXI.resources.BasisResource.TranscoderWorker has not been given the transcoder WASM binary!"),this.worker=new Worker(e.workerURL),this.worker.onmessage=this.onMessage,this.worker.postMessage({type:"init",jsSource:e.jsSource,wasmSource:e.wasmSource})}return Object.defineProperty(e,"workerURL",{get:function(){if(!e._workerURL){var r=A.toString(),t=r.indexOf("{"),n=r.lastIndexOf("}");r=r.slice(t+1,n),e.jsSource&&(r=e.jsSource+"\n"+r),e._workerURL=URL.createObjectURL(new Blob([r]))}return e._workerURL},enumerable:!1,configurable:!0}),e.prototype.initAsync=function(){return this.initPromise},e.prototype.transcodeAsync=function(r,t,n){return u(this,void 0,Promise,(function(){var s,o,a=this;return l(this,(function(i){return++this.load,s=e._tempID++,o=new Promise((function(e,r){a.requests[s]={resolve:e,reject:r}})),this.worker.postMessage({requestID:s,basisData:r,rgbaFormat:t,rgbFormat:n,type:"transcode"}),[2,o]}))}))},e.loadTranscoder=function(r,t){var n=this,s=fetch(r).then((function(e){return e.text()})).then((function(r){e.jsSource=r})),o=fetch(t).then((function(e){return e.arrayBuffer()})).then((function(r){e.wasmSource=r}));return Promise.all([s,o]).then((function(e){return n._onTranscoderInitializedResolve(),e}))},e.setTranscoder=function(r,t){e.jsSource=r,e.wasmSource=t},e.onTranscoderInitialized=new Promise((function(r){e._onTranscoderInitializedResolve=r})),e._tempID=0,e}(),R=function(){function e(){}return e.transcode=function(r){return u(this,void 0,Promise,(function(){var t;return l(this,(function(n){switch(n.label){case 0:return"undefined"!=typeof Worker&&e.TranscoderWorker.wasmSource?[4,e.transcodeAsync(r)]:[3,2];case 1:return t=n.sent(),[3,3];case 2:t=e.transcodeSync(r),n.label=3;case 3:return[2,t]}}))}))},e.transcodeAsync=function(r){return u(this,void 0,Promise,(function(){var t,n,o,i,c,u,d,f,_,A;return l(this,(function(l){switch(l.label){case 0:for(e.defaultRGBAFormat||e.defaultRGBFormat||e.autoDetectFormats(),t=e.workerPool,n=268435456,o=null,_=0,A=t.length;_<A;_++)t[_].load<n&&(o=t[_],n=o.load);return o||(o=new S,t.push(o)),[4,o.initAsync()];case 1:return l.sent(),[4,o.transcodeAsync(new Uint8Array(r),e.defaultRGBAFormat.basisFormat,e.defaultRGBFormat.basisFormat)];case 2:if(i=l.sent(),c=i.basisFormat,u=i.imageArray,c>12)d=u.map((function(e){return new s.BufferResource(new Uint16Array(e.levelArray[0].levelBuffer.buffer),{width:e.width,height:e.height})}));else for(f=T[i.basisFormat],d=new Array(u.length),_=0,A=u.length;_<A;_++)d[_]=new a.CompressedTextureResource(null,{format:f,width:u[_].width,height:u[_].height,levelBuffers:u[_].levelArray,levels:u[_].levelArray.length});return d.basisFormat=c,[2,d]}}))}))},e.transcodeSync=function(r){e.defaultRGBAFormat||e.defaultRGBFormat||e.autoDetectFormats();var t=e.basisBinding,n=new Uint8Array(r),o=new t.BasisFile(n),i=o.getNumImages(),c=o.getHasAlpha()?e.defaultRGBAFormat.basisFormat:e.defaultRGBFormat.basisFormat,u=exports.BASIS_FORMATS.cTFRGB565,l=new Array(i),d=e.fallbackMode;if(!o.startTranscoding())return o.close(),o.delete(),null;for(var f=0;f<i;f++){for(var _=d?1:o.getNumLevels(f),A=o.getImageWidth(f,0),S=o.getImageHeight(f,0),R=A+3&-4,B=S+3&-4,F=new Array(_),h=0;h<_;h++){var m=o.getImageWidth(f,h),p=o.getImageHeight(f,h),g=o.getImageTranscodedSizeInBytes(f,0,d?u:c);if(F[h]={levelID:h,levelBuffer:new Uint8Array(g),levelWidth:m,levelHeight:p},o.transcodeImage(F[h].levelBuffer,f,0,d?u:c,!1,!1));else{if(d)break;f=-1,d=!0}}var v=void 0;v=d?new s.BufferResource(new Uint16Array(F[0].levelBuffer.buffer),{width:A,height:S}):new a.CompressedTextureResource(null,{format:T[c],width:R,height:B,levelBuffers:F,levels:_}),l[f]=v}o.close(),o.delete();var x=l;return x.basisFormat=d?u:c,x},e.autoDetectFormats=function(r){if(!r){var t=c.settings.ADAPTER.createCanvas().getContext("webgl");if(!t)return void console.error("WebGL not available for BASIS transcoding. Silently failing.");r={s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),astc:t.getExtension("WEBGL_compressed_texture_astc"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc")}}var n={};for(var s in r){var a=r[s];a&&Object.assign(n,Object.getPrototypeOf(a))}for(var i=0;i<2;i++){var u=!!i,l=void 0,T=void 0;for(var d in n)if(void 0!==(T=f[l=n[d]])&&(u&&_[T]||!u&&!_[T]))break;l?e[u?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:l,basisFormat:T}:(e[u?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:o.TYPES.UNSIGNED_SHORT_5_6_5,basisFormat:exports.BASIS_FORMATS.cTFRGB565},e.fallbackMode=!0)}},e.bindTranscoder=function(r){e.basisBinding=r},e.loadTranscoder=function(r,t){return e.TranscoderWorker.loadTranscoder(r,t)},e.setTranscoder=function(r,t){e.TranscoderWorker.setTranscoder(r,t)},Object.defineProperty(e,"TRANSCODER_WORKER_POOL_LIMIT",{get:function(){return this.workerPool.length||1},set:function(e){for(var r=this.workerPool.length;r<e;r++)this.workerPool[r]=new S,this.workerPool[r].initAsync()},enumerable:!1,configurable:!0}),e.extension=s.ExtensionType.Loader,e.fallbackMode=!1,e.workerPool=[],e.TranscoderWorker=S,e}();i.LoaderResource.setExtensionXhrType("basis",i.LoaderResource.XHR_RESPONSE_TYPE.BUFFER);var B=function(){function e(){}return e.use=function(r,t){var n=this;"basis"===r.extension&&r.data?u(n,void 0,void 0,(function(){var n;return l(this,(function(s){switch(s.label){case 0:return R.basisBinding||R.TranscoderWorker.wasmSource?[3,2]:[4,S.onTranscoderInitialized];case 1:s.sent(),s.label=2;case 2:return[4,R.transcode(r.data)];case 3:return n=s.sent(),Object.assign(r,e.registerTextures(r.url,n,r.metadata)),t(),[2]}}))})):t()},e.registerTextures=function(e,r,t){var n={textures:{},texture:null};if(!r)return n;var i=d[r.basisFormat],c=r.basisFormat!==exports.BASIS_FORMATS.cTFRGBA32?o.FORMATS.RGB:o.FORMATS.RGBA;return r.map((function(e){return new s.Texture(new s.BaseTexture(e,Object.assign({mipmap:e instanceof a.CompressedTextureResource&&e.levels>1?o.MIPMAP_MODES.ON_MANUAL:o.MIPMAP_MODES.OFF,alphaMode:o.ALPHA_MODES.NO_PREMULTIPLIED_ALPHA,type:i,format:c},t)))})).forEach((function(r,t){var o=r.baseTexture,a=e+"-"+(t+1);s.BaseTexture.addToCache(o,a),s.Texture.addToCache(r,a),0===t&&(s.BaseTexture.addToCache(o,e),s.Texture.addToCache(r,e),n.texture=r),n.textures[a]=r})),n},e.bindTranscoder=function(e){R.basisBinding=e},e.loadTranscoder=function(e,r){return R.TranscoderWorker.loadTranscoder(e,r)},e.setTranscoder=function(e,r){R.TranscoderWorker.setTranscoder(e,r)},e.extension=s.ExtensionType.Loader,e}();s.extensions.add(B),exports.BASIS_FORMATS_ALPHA=_,exports.BASIS_FORMAT_TO_INTERNAL_FORMAT=T,exports.BASIS_FORMAT_TO_TYPE=d,exports.BasisLoader=B,exports.BasisParser=R,exports.INTERNAL_FORMAT_TO_BASIS_FORMAT=f,exports.TranscoderWorker=S;
//# sourceMappingURL=basis.min.js.map
