/*!
 * @pixi/basis - v6.5.10
 * Compiled Thu, 06 Jul 2023 15:25:11 UTC
 *
 * @pixi/basis is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
import{ExtensionType as e,BufferResource as r,Texture as t,BaseTexture as n,extensions as o}from"@pixi/core";import{TYPES as s,FORMATS as a,MIPMAP_MODES as i,ALPHA_MODES as c}from"@pixi/constants";import{INTERNAL_FORMATS as u,CompressedTextureResource as l}from"@pixi/compressed-textures";import{LoaderResource as f}from"@pixi/loaders";import{settings as d}from"@pixi/settings";function T(e,r,t,n){return new(t||(t=Promise))((function(o,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function i(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,i)}c((n=n.apply(e,r||[])).next())}))}function m(e,r){var t,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=r.call(e,a)}catch(e){s=[6,e],n=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}var _,h,B,g;!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444"}(g||(g={}));var v=((_={})[g.cTFETC1]=u.COMPRESSED_RGB_ETC1_WEBGL,_[g.cTFBC1]=u.COMPRESSED_RGB_S3TC_DXT1_EXT,_[g.cTFBC3]=u.COMPRESSED_RGBA_S3TC_DXT5_EXT,_[g.cTFPVRTC1_4_RGB]=u.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,_[g.cTFPVRTC1_4_RGBA]=u.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,_[g.cTFATC_RGB]=u.COMPRESSED_RGB_ATC_WEBGL,_[g.cTFASTC_4x4]=u.COMPRESSED_RGBA_ASTC_4x4_KHR,_),R=((h={})[g.cTFRGBA32]=s.UNSIGNED_BYTE,h[g.cTFRGB565]=s.UNSIGNED_SHORT_5_6_5,h[g.cTFRGBA4444]=s.UNSIGNED_SHORT_4_4_4_4,h),F=Object.keys(v).map((function(e){return Number(e)})).reduce((function(e,r){return e[v[r]]=r,e}),{}),p=((B={})[g.cTFBC3]=!0,B[g.cTFPVRTC1_4_RGBA]=!0,B[g.cTFASTC_4x4]=!0,B);function A(){var e,r={init:function(r){return self.BASIS?(self.BASIS({wasmBinary:r.wasmSource}).then((function(r){r.initializeBasis(),e=r,self.postMessage({type:"init",success:!0})})),null):(console.warn("jsSource was not prepended?"),{type:"init",success:!1})},transcode:function(r){var t=r.basisData,n=new e.BasisFile(t),o=n.getNumImages(),s=n.getHasAlpha()?r.rgbaFormat:r.rgbFormat,a=new Array(o),i=!1;if(!n.startTranscoding())return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!1,imageArray:null};for(var c=0;c<o;c++){for(var u=n.getNumLevels(c),l={imageID:c,levelArray:new Array,width:null,height:null},f=0;f<u;f++){var d=i?14:s,T=n.getImageWidth(c,f),m=n.getImageHeight(c,f),_=n.getImageTranscodedSizeInBytes(c,f,d),h=T+3&-4,B=m+3&-4;0===f&&(l.width=h,l.height=B);var g=new Uint8Array(_);if(!n.transcodeImage(g,c,f,d,!1,!1)){if(i)return console.error("Basis failed to transcode image "+c+", level "+f+"!"),{type:"transcode",requestID:r.requestID,success:!1};console.warn("Basis failed to transcode image "+c+", level "+f+"! Retrying to an uncompressed texture format!"),c=-1,i=!0;break}l.levelArray.push({levelID:f,levelWidth:T,levelHeight:m,levelBuffer:g})}a[c]=l}return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!0,basisFormat:i?14:s,imageArray:a}}};self.onmessage=function(e){var t=e.data,n=r[t.type](t);n&&self.postMessage(n)}}var w=function(){function e(){var r=this;this.requests={},this.onMessage=function(e){var t=e.data;if("init"===t.type){if(!t.success)throw new Error("BasisResource.TranscoderWorker failed to initialize.");r.isInit=!0,r.onInit()}else if("transcode"===t.type){--r.load;var n=t.requestID;t.success?r.requests[n].resolve(t):r.requests[n].reject(),delete r.requests[n]}},this.isInit=!1,this.load=0,this.initPromise=new Promise((function(e){r.onInit=e})),e.wasmSource||console.warn("PIXI.resources.BasisResource.TranscoderWorker has not been given the transcoder WASM binary!"),this.worker=new Worker(e.workerURL),this.worker.onmessage=this.onMessage,this.worker.postMessage({type:"init",jsSource:e.jsSource,wasmSource:e.wasmSource})}return Object.defineProperty(e,"workerURL",{get:function(){if(!e._workerURL){var r=A.toString(),t=r.indexOf("{"),n=r.lastIndexOf("}");r=r.slice(t+1,n),e.jsSource&&(r=e.jsSource+"\n"+r),e._workerURL=URL.createObjectURL(new Blob([r]))}return e._workerURL},enumerable:!1,configurable:!0}),e.prototype.initAsync=function(){return this.initPromise},e.prototype.transcodeAsync=function(r,t,n){return T(this,void 0,Promise,(function(){var o,s,a=this;return m(this,(function(i){return++this.load,o=e._tempID++,s=new Promise((function(e,r){a.requests[o]={resolve:e,reject:r}})),this.worker.postMessage({requestID:o,basisData:r,rgbaFormat:t,rgbFormat:n,type:"transcode"}),[2,s]}))}))},e.loadTranscoder=function(r,t){var n=this,o=fetch(r).then((function(e){return e.text()})).then((function(r){e.jsSource=r})),s=fetch(t).then((function(e){return e.arrayBuffer()})).then((function(r){e.wasmSource=r}));return Promise.all([o,s]).then((function(e){return n._onTranscoderInitializedResolve(),e}))},e.setTranscoder=function(r,t){e.jsSource=r,e.wasmSource=t},e.onTranscoderInitialized=new Promise((function(r){e._onTranscoderInitializedResolve=r})),e._tempID=0,e}(),b=function(){function t(){}return t.transcode=function(e){return T(this,void 0,Promise,(function(){var r;return m(this,(function(n){switch(n.label){case 0:return"undefined"!=typeof Worker&&t.TranscoderWorker.wasmSource?[4,t.transcodeAsync(e)]:[3,2];case 1:return r=n.sent(),[3,3];case 2:r=t.transcodeSync(e),n.label=3;case 3:return[2,r]}}))}))},t.transcodeAsync=function(e){return T(this,void 0,Promise,(function(){var n,o,s,a,i,c,u,f,d,T;return m(this,(function(m){switch(m.label){case 0:for(t.defaultRGBAFormat||t.defaultRGBFormat||t.autoDetectFormats(),n=t.workerPool,o=268435456,s=null,d=0,T=n.length;d<T;d++)n[d].load<o&&(s=n[d],o=s.load);return s||(s=new w,n.push(s)),[4,s.initAsync()];case 1:return m.sent(),[4,s.transcodeAsync(new Uint8Array(e),t.defaultRGBAFormat.basisFormat,t.defaultRGBFormat.basisFormat)];case 2:if(a=m.sent(),i=a.basisFormat,c=a.imageArray,i>12)u=c.map((function(e){return new r(new Uint16Array(e.levelArray[0].levelBuffer.buffer),{width:e.width,height:e.height})}));else for(f=v[a.basisFormat],u=new Array(c.length),d=0,T=c.length;d<T;d++)u[d]=new l(null,{format:f,width:c[d].width,height:c[d].height,levelBuffers:c[d].levelArray,levels:c[d].levelArray.length});return u.basisFormat=i,[2,u]}}))}))},t.transcodeSync=function(e){t.defaultRGBAFormat||t.defaultRGBFormat||t.autoDetectFormats();var n=t.basisBinding,o=new Uint8Array(e),s=new n.BasisFile(o),a=s.getNumImages(),i=s.getHasAlpha()?t.defaultRGBAFormat.basisFormat:t.defaultRGBFormat.basisFormat,c=g.cTFRGB565,u=new Array(a),f=t.fallbackMode;if(!s.startTranscoding())return s.close(),s.delete(),null;for(var d=0;d<a;d++){for(var T=f?1:s.getNumLevels(d),m=s.getImageWidth(d,0),_=s.getImageHeight(d,0),h=m+3&-4,B=_+3&-4,R=new Array(T),F=0;F<T;F++){var p=s.getImageWidth(d,F),A=s.getImageHeight(d,F),w=s.getImageTranscodedSizeInBytes(d,0,f?c:i);if(R[F]={levelID:F,levelBuffer:new Uint8Array(w),levelWidth:p,levelHeight:A},s.transcodeImage(R[F].levelBuffer,d,0,f?c:i,!1,!1));else{if(f)break;d=-1,f=!0}}var b=void 0;b=f?new r(new Uint16Array(R[0].levelBuffer.buffer),{width:m,height:_}):new l(null,{format:v[i],width:h,height:B,levelBuffers:R,levels:T}),u[d]=b}s.close(),s.delete();var y=u;return y.basisFormat=f?c:i,y},t.autoDetectFormats=function(e){if(!e){var r=d.ADAPTER.createCanvas().getContext("webgl");if(!r)return void console.error("WebGL not available for BASIS transcoding. Silently failing.");e={s3tc:r.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:r.getExtension("WEBGL_compressed_texture_s3tc_srgb"),astc:r.getExtension("WEBGL_compressed_texture_astc"),etc:r.getExtension("WEBGL_compressed_texture_etc"),etc1:r.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:r.getExtension("WEBGL_compressed_texture_atc")}}var n={};for(var o in e){var a=e[o];a&&Object.assign(n,Object.getPrototypeOf(a))}for(var i=0;i<2;i++){var c=!!i,u=void 0,l=void 0;for(var f in n)if(void 0!==(l=F[u=n[f]])&&(c&&p[l]||!c&&!p[l]))break;u?t[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:u,basisFormat:l}:(t[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:s.UNSIGNED_SHORT_5_6_5,basisFormat:g.cTFRGB565},t.fallbackMode=!0)}},t.bindTranscoder=function(e){t.basisBinding=e},t.loadTranscoder=function(e,r){return t.TranscoderWorker.loadTranscoder(e,r)},t.setTranscoder=function(e,r){t.TranscoderWorker.setTranscoder(e,r)},Object.defineProperty(t,"TRANSCODER_WORKER_POOL_LIMIT",{get:function(){return this.workerPool.length||1},set:function(e){for(var r=this.workerPool.length;r<e;r++)this.workerPool[r]=new w,this.workerPool[r].initAsync()},enumerable:!1,configurable:!0}),t.extension=e.Loader,t.fallbackMode=!1,t.workerPool=[],t.TranscoderWorker=w,t}();f.setExtensionXhrType("basis",f.XHR_RESPONSE_TYPE.BUFFER);var y=function(){function r(){}return r.use=function(e,t){var n=this;"basis"===e.extension&&e.data?T(n,void 0,void 0,(function(){var n;return m(this,(function(o){switch(o.label){case 0:return b.basisBinding||b.TranscoderWorker.wasmSource?[3,2]:[4,w.onTranscoderInitialized];case 1:o.sent(),o.label=2;case 2:return[4,b.transcode(e.data)];case 3:return n=o.sent(),Object.assign(e,r.registerTextures(e.url,n,e.metadata)),t(),[2]}}))})):t()},r.registerTextures=function(e,r,o){var s={textures:{},texture:null};if(!r)return s;var u=R[r.basisFormat],f=r.basisFormat!==g.cTFRGBA32?a.RGB:a.RGBA;return r.map((function(e){return new t(new n(e,Object.assign({mipmap:e instanceof l&&e.levels>1?i.ON_MANUAL:i.OFF,alphaMode:c.NO_PREMULTIPLIED_ALPHA,type:u,format:f},o)))})).forEach((function(r,o){var a=r.baseTexture,i=e+"-"+(o+1);n.addToCache(a,i),t.addToCache(r,i),0===o&&(n.addToCache(a,e),t.addToCache(r,e),s.texture=r),s.textures[i]=r})),s},r.bindTranscoder=function(e){b.basisBinding=e},r.loadTranscoder=function(e,r){return b.TranscoderWorker.loadTranscoder(e,r)},r.setTranscoder=function(e,r){b.TranscoderWorker.setTranscoder(e,r)},r.extension=e.Loader,r}();o.add(y);export{g as BASIS_FORMATS,p as BASIS_FORMATS_ALPHA,v as BASIS_FORMAT_TO_INTERNAL_FORMAT,R as BASIS_FORMAT_TO_TYPE,y as BasisLoader,b as BasisParser,F as INTERNAL_FORMAT_TO_BASIS_FORMAT,w as TranscoderWorker};
//# sourceMappingURL=basis.min.mjs.map
